{% extends "base.html" %}

{% block content %}
<div class="user-profile">
    <div class="card mt-4" style="border-radius: 10px">
        <div class="card-header p-4">
            <h1 class="card-header-title title has-text-centered">{{ user.username }}</h1>
        </div>
        <div class="card-content p-4">
            <div class="media mb-1">
                <div class="media-left">
                    <figure class="image is-128x128">
                        <img class="is-rounded" src="/static/img/{{ user.profile_picture }}" class="user-picture"></img>
                    </figure>
                </div>
                <div class="media-content">
                    <div>
                        <h3>New Transaction</h3>
                        <form id="transaction_form" action="/transaction" method="post">
                            <input class="input" name="to" type="hidden" value="{{ user.username }}">
                            <div class="field has-addons">
                                <div class="control">
                                    <input class="input" name="amount" type="number" placeholder="Amount" min="0.01" step="0.01" value="10.00" required />
                                </div>
                                <div class="control">
                                    <input class="button is-info" id="send_money" type="submit" value="Send money">
                                </div>
                              </div>
                        </form>
                    </div>
                    {% if user.username == identikey %}
                    <script>
                    /*
                    * This is a hack which allows students to click the 'Send money' button without redirecting to a
                    * new page, or infinitely looping on this one. This allows them to easily test their XSS attacks.
                    */
                    transaction_form.onsubmit = function() {
                        let form_data = new FormData(transaction_form);
                    
                        error = `
                        <li class="flash-warning" onclick="this.classList.add('hidden')">
                            You cannot send money to yourself<br/><i class="dismiss-text">click to dismiss</i>
                        </li>`;
                        document.querySelector('.flash-messages').insertAdjacentHTML('afterbegin', error);
                        return false;
                    }
                    </script>
                    {% endif %}
                </div>
            </div>
            
            <div class="content">
                <div>
                    <div class="text container vertical">
                        <div>{{ user.biography | safe }}</div>
                        {% if user.username == identikey %}
                        <button onclick="biography.classList.toggle('editing')">Edit Biography</button>
                        {% endif %}
                    </div>
                        <form id="biography_form" method="post">
                            <textarea name="biography">{{ user.biography }}</textarea>
                            <input type="submit" value="Save">
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
        <div class="transaction-wrapper">
            <h3>Transactions</h3>
            {% if not transactions %}
            This user has no transactions
            {% endif %}
            <ul class="transaction-list nostyle">
                {% for t in transactions %}
                <li class="transaction">
                    {% if t.sender == user.username %}
                        {% if t.amount >= 0 %}
                            <h4><b class="red">${{ "{:.2f}".format(t.amount) }}</b> to {{ t.recipient }}
                            <i>{{ t.time.strftime("%I:%M %p") }}</i></h4>
                        {% else %}
                            <h4><b class="green">${{ "{:.2f}".format(-t.amount) }}</b> from {{ t.recipient }}
                            <i>{{ t.time.strftime("%I:%M %p") }}</i></h4>
                        {% endif %}
                    {% else %}
                        {% if t.amount >= 0 %}
                            <h4><b class="green">${{ "{:.2f}".format(t.amount) }}</b> from {{ t.sender }}
                            <i>{{ t.time.strftime("%I:%M %p") }}</i></h4>
                        {% else %}
                            <h4><b class="red">${{ "{:.2f}".format(-t.amount) }}</b> to {{ t.sender }}
                            <i>{{ t.time.strftime("%I:%M %p") }}</i></h4>
                        {% endif %}
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}
